"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Client = void 0;

var _logger = _interopRequireDefault(require("../logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const dafaultFields = ['className', 'objectId', 'updatedAt', 'createdAt', 'ACL'];

class Client {
  constructor(id, parseWebSocket, hasMasterKey = false, sessionToken, installationId) {
    this.id = id;
    this.parseWebSocket = parseWebSocket;
    this.hasMasterKey = hasMasterKey;
    this.sessionToken = sessionToken;
    this.installationId = installationId;
    this.roles = [];
    this.subscriptionInfos = new Map();
    this.pushConnect = this._pushEvent('connected');
    this.pushSubscribe = this._pushEvent('subscribed');
    this.pushUnsubscribe = this._pushEvent('unsubscribed');
    this.pushCreate = this._pushEvent('create');
    this.pushEnter = this._pushEvent('enter');
    this.pushUpdate = this._pushEvent('update');
    this.pushDelete = this._pushEvent('delete');
    this.pushLeave = this._pushEvent('leave');
  }

  static pushResponse(parseWebSocket, message) {
    _logger.default.verbose('Push Response : %j', message);

    parseWebSocket.send(message);
  }

  static pushError(parseWebSocket, code, error, reconnect = true, requestId = null) {
    Client.pushResponse(parseWebSocket, JSON.stringify({
      op: 'error',
      error,
      code,
      reconnect,
      requestId
    }));
  }

  addSubscriptionInfo(requestId, subscriptionInfo) {
    this.subscriptionInfos.set(requestId, subscriptionInfo);
  }

  getSubscriptionInfo(requestId) {
    return this.subscriptionInfos.get(requestId);
  }

  deleteSubscriptionInfo(requestId) {
    return this.subscriptionInfos.delete(requestId);
  }

  _pushEvent(type) {
    return function (subscriptionId, parseObjectJSON, parseOriginalObjectJSON) {
      const response = {
        op: type,
        clientId: this.id,
        installationId: this.installationId
      };

      if (typeof subscriptionId !== 'undefined') {
        response['requestId'] = subscriptionId;
      }

      if (typeof parseObjectJSON !== 'undefined') {
        let fields;

        if (this.subscriptionInfos.has(subscriptionId)) {
          fields = this.subscriptionInfos.get(subscriptionId).fields;
        }

        response['object'] = this._toJSONWithFields(parseObjectJSON, fields);

        if (parseOriginalObjectJSON) {
          response['original'] = this._toJSONWithFields(parseOriginalObjectJSON, fields);
        }
      }

      Client.pushResponse(this.parseWebSocket, JSON.stringify(response));
    };
  }

  _toJSONWithFields(parseObjectJSON, fields) {
    if (!fields) {
      return parseObjectJSON;
    }

    const limitedParseObject = {};

    for (const field of dafaultFields) {
      limitedParseObject[field] = parseObjectJSON[field];
    }

    for (const field of fields) {
      if (field in parseObjectJSON) {
        limitedParseObject[field] = parseObjectJSON[field];
      }
    }

    return limitedParseObject;
  }

}

exports.Client = Client;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9MaXZlUXVlcnkvQ2xpZW50LmpzIl0sIm5hbWVzIjpbImRhZmF1bHRGaWVsZHMiLCJDbGllbnQiLCJjb25zdHJ1Y3RvciIsImlkIiwicGFyc2VXZWJTb2NrZXQiLCJoYXNNYXN0ZXJLZXkiLCJzZXNzaW9uVG9rZW4iLCJpbnN0YWxsYXRpb25JZCIsInJvbGVzIiwic3Vic2NyaXB0aW9uSW5mb3MiLCJNYXAiLCJwdXNoQ29ubmVjdCIsIl9wdXNoRXZlbnQiLCJwdXNoU3Vic2NyaWJlIiwicHVzaFVuc3Vic2NyaWJlIiwicHVzaENyZWF0ZSIsInB1c2hFbnRlciIsInB1c2hVcGRhdGUiLCJwdXNoRGVsZXRlIiwicHVzaExlYXZlIiwicHVzaFJlc3BvbnNlIiwibWVzc2FnZSIsImxvZ2dlciIsInZlcmJvc2UiLCJzZW5kIiwicHVzaEVycm9yIiwiY29kZSIsImVycm9yIiwicmVjb25uZWN0IiwicmVxdWVzdElkIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9wIiwiYWRkU3Vic2NyaXB0aW9uSW5mbyIsInN1YnNjcmlwdGlvbkluZm8iLCJzZXQiLCJnZXRTdWJzY3JpcHRpb25JbmZvIiwiZ2V0IiwiZGVsZXRlU3Vic2NyaXB0aW9uSW5mbyIsImRlbGV0ZSIsInR5cGUiLCJzdWJzY3JpcHRpb25JZCIsInBhcnNlT2JqZWN0SlNPTiIsInBhcnNlT3JpZ2luYWxPYmplY3RKU09OIiwicmVzcG9uc2UiLCJjbGllbnRJZCIsImZpZWxkcyIsImhhcyIsIl90b0pTT05XaXRoRmllbGRzIiwibGltaXRlZFBhcnNlT2JqZWN0IiwiZmllbGQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUtBLE1BQU1BLGFBQWEsR0FBRyxDQUNwQixXQURvQixFQUVwQixVQUZvQixFQUdwQixXQUhvQixFQUlwQixXQUpvQixFQUtwQixLQUxvQixDQUF0Qjs7QUFRQSxNQUFNQyxNQUFOLENBQWE7QUFrQlhDLEVBQUFBLFdBQVcsQ0FDVEMsRUFEUyxFQUVUQyxjQUZTLEVB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aW1wb3J0IHR5cGUgeyBGbGF0dGVuZWRPYmplY3REYXRhIH0gZnJvbSAnLi9TdWJzY3JpcHRpb24nO1xuZXhwb3J0IHR5cGUgTWVzc2FnZSA9IHsgW2F0dHI6IHN0cmluZ106IGFueSB9O1xuXG5jb25zdCBkYWZhdWx0RmllbGRzID0gW1xuICAnY2xhc3NOYW1lJyxcbiAgJ29iamVjdElkJyxcbiAgJ3VwZGF0ZWRBdCcsXG4gICdjcmVhdGVkQXQnLFxuICAnQUNMJyxcbl07XG5cbmNsYXNzIENsaWVudCB7XG4gIGlkOiBudW1iZXI7XG4gIHBhcnNlV2ViU29ja2V0OiBhbnk7XG4gIGhhc01hc3RlcktleTogYm9vbGVhbjtcbiAgc2Vzc2lvblRva2VuOiBzdHJpbmc7XG4gIGluc3RhbGxhdGlvbklkOiBzdHJpbmc7XG4gIHVzZXJJZDogc3RyaW5nO1xuICByb2xlczogQXJyYXk8c3RyaW5nPjtcbiAgc3Vic2NyaXB0aW9uSW5mb3M6IE9iamVjdDtcbiAgcHVzaENvbm5lY3Q6IEZ1bmN0aW9uO1xuICBwdXNoU3Vic2NyaWJlOiBGdW5jdGlvbjtcbiAgcHVzaFVuc3Vic2NyaWJlOiBGdW5jdGlvbjtcbiAgcHVzaENyZWF0ZTogRnVuY3Rpb247XG4gIHB1c2hFbnRlcjogRnVuY3Rpb247XG4gIHB1c2hVcGRhdGU6IEZ1bmN0aW9uO1xuICBwdXNoRGVsZXRlOiBGdW5jdGlvbjtcbiAgcHVzaExlYXZlOiBGdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBpZDogbnVtYmVyLFxuICAgIHBhcnNlV2ViU29ja2V0OiBhbnksXG4gICAgaGFzTWFzdGVyS2V5OiBib29sZWFuID0gZmFsc2UsXG4gICAgc2Vzc2lvblRva2VuOiBzdHJpbmcsXG4gICAgaW5zdGFsbGF0aW9uSWQ6IHN0cmluZ1xuICApIHtcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy5wYXJzZVdlYlNvY2tldCA9IHBhcnNlV2ViU29ja2V0O1xuICAgIHRoaXMuaGFzTWFzdGVyS2V5ID0gaGFzTWFzdGVyS2V5O1xuICAgIHRoaXMuc2Vzc2lvblRva2VuID0gc2Vzc2lvblRva2VuO1xuICAgIHRoaXMuaW5zdGFsbGF0aW9uSWQgPSBpbnN0YWxsYXRpb25JZDtcbiAgICB0aGlzLnJvbGVzID0gW107XG4gICAgdGhpcy5zdWJzY3JpcHRpb25JbmZvcyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLnB1c2hDb25uZWN0ID0gdGhpcy5fcHVzaEV2ZW50KCdjb25uZWN0ZWQnKTtcbiAgICB0aGlzLnB1c2hTdWJzY3JpYmUgPSB0aGlzLl9wdXNoRXZlbnQoJ3N1YnNjcmliZWQnKTtcbiAgICB0aGlzLnB1c2hVbnN1YnNjcmliZSA9IHRoaXMuX3B1c2hFdmVudCgndW5zdWJzY3JpYmVkJyk7XG4gICAgdGhpcy5wdXNoQ3JlYXRlID0gdGhpcy5fcHVzaEV2ZW50KCdjcmVhdGUnKTtcbiAgICB0aGlzLnB1c2hFbnRlciA9IHRoaXMuX3B1c2hFdmVudCgnZW50ZXInKTtcbiAgICB0aGlzLnB1c2hVcGRhdGUgPSB0aGlzLl9wdXNoRXZlbnQoJ3VwZGF0ZScpO1xuICAgIHRoaXMucHVzaERlbGV0ZSA9IHRoaXMuX3B1c2hFdmVudCgnZGVsZXRlJyk7XG4gICAgdGhpcy5wdXNoTGVhdmUgPSB0aGlzLl9wdXNoRXZlbnQoJ2xlYXZlJyk7XG4gIH1cblxuICBzdGF0aWMgcHVzaFJlc3BvbnNlKHBhcnNlV2ViU29ja2V0OiBhbnksIG1lc3NhZ2U6IE1lc3NhZ2UpOiB2b2lkIHtcbiAgICBsb2dnZXIudmVyYm9zZSgnUHVzaCBSZXNwb25zZSA6ICVqJywgbWVzc2FnZSk7XG4gICAgcGFyc2VXZWJTb2NrZXQuc2VuZChtZXNzYWdlKTtcbiAgfVxuXG4gIHN0YXRpYyBwdXNoRXJyb3IoXG4gICAgcGFyc2VXZWJTb2NrZXQ6IGFueSxcbiAgICBjb2RlOiBudW1iZXIsXG4gICAgZXJyb3I6IHN0cmluZyxcbiAgICByZWNvbm5lY3Q6IGJvb2xlYW4gPSB0cnVlLFxuICAgIHJlcXVlc3RJZDogbnVtYmVyIHwgdm9pZCA9IG51bGxcbiAgKTogdm9pZCB7XG4gICAgQ2xpZW50LnB1c2hSZXNwb25zZShcbiAgICAgIHBhcnNlV2ViU29ja2V0LFxuICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBvcDogJ2Vycm9yJyxcbiAgICAgICAgZXJyb3IsXG4gICAgICAgIGNvZGUsXG4gICAgICAgIHJlY29ubmVjdCxcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgYWRkU3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlciwgc3Vic2NyaXB0aW9uSW5mbzogYW55KTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25JbmZvcy5zZXQocmVxdWVzdElkLCBzdWJzY3JpcHRpb25JbmZvKTtcbiAgfVxuXG4gIGdldFN1YnNjcmlwdGlvbkluZm8ocmVxdWVzdElkOiBudW1iZXIpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmdldChyZXF1ZXN0SWQpO1xuICB9XG5cbiAgZGVsZXRlU3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlcik6IHZvaWQge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmRlbGV0ZShyZXF1ZXN0SWQpO1xuICB9XG5cbiAgX3B1c2hFdmVudCh0eXBlOiBzdHJpbmcpOiBGdW5jdGlvbiB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIChcbiAgICAgIHN1YnNjcmlwdGlvbklkOiBudW1iZXIsXG4gICAgICBwYXJzZU9iamVjdEpTT046IGFueSxcbiAgICAgIHBhcnNlT3JpZ2luYWxPYmplY3RKU09OOiBhbnlcbiAgICApOiB2b2lkIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlOiBNZXNzYWdlID0ge1xuICAgICAgICBvcDogdHlwZSxcbiAgICAgICAgY2xpZW50SWQ6IHRoaXMuaWQsXG4gICAgICAgIGluc3RhbGxhdGlvbklkOiB0aGlzLmluc3RhbGxhdGlvbklkLFxuICAgICAgfTtcbiAgICAgIGlmICh0eXBlb2Ygc3Vic2NyaXB0aW9uSWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHJlc3BvbnNlWydyZXF1ZXN0SWQnXSA9IHN1YnNjcmlwdGlvbklkO1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBwYXJzZU9iamVjdEpTT04gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxldCBmaWVsZHM7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmhhcyhzdWJzY3JpcHRpb25JZCkpIHtcbiAgICAgICAgICBmaWVsZHMgPSB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmdldChzdWJzY3JpcHRpb25JZCkuZmllbGRzO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlWydvYmplY3QnXSA9IHRoaXMuX3RvSlNPTldpdGhGaWVsZHMocGFyc2VPYmplY3RKU09OLCBmaWVsZHMpO1xuICAgICAgICBpZiAocGFyc2VPcmlnaW5hbE9iamVjdEpTT04pIHtcbiAgICAgICAgICByZXNwb25zZVsnb3JpZ2luYWwnXSA9IHRoaXMuX3RvSlNPTldpdGhGaWVsZHMoXG4gICAgICAgICAgICBwYXJzZU9yaWdpbmFsT2JqZWN0SlNPTixcbiAgICAgICAgICAgIGZpZWxkc1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIENsaWVudC5wdXNoUmVzcG9uc2UodGhpcy5wYXJzZVdlYlNvY2tldCwgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9O1xuICB9XG5cbiAgX3RvSlNPTldpdGhGaWVsZHMocGFyc2VPYmplY3RKU09OOiBhbnksIGZpZWxkczogYW55KTogRmxhdHRlbmVkT2JqZWN0RGF0YSB7XG4gICAgaWYgKCFmaWVsZHMpIHtcbiAgICAgIHJldHVybiBwYXJzZU9iamVjdEpTT047XG4gICAgfVxuICAgIGNvbnN0IGxpbWl0ZWRQYXJzZU9iamVjdCA9IHt9O1xuICAgIGZvciAoY29uc3QgZmllbGQgb2YgZGFmYXVsdEZpZWxkcykge1xuICAgICAgbGltaXRlZFBhcnNlT2JqZWN0W2ZpZWxkXSA9IHBhcnNlT2JqZWN0SlNPTltmaWVsZF07XG4gICAgfVxuICAgIGZvciAoY29uc3QgZmllbGQgb2YgZmllbGRzKSB7XG4gICAgICBpZiAoZmllbGQgaW4gcGFyc2VPYmplY3RKU09OKSB7XG4gICAgICAgIGxpbWl0ZWRQYXJzZU9iamVjdFtmaWVsZF0gPSBwYXJzZU9iamVjdEpTT05bZmllbGRdO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbGltaXRlZFBhcnNlT2JqZWN0O1xuICB9XG59XG5cbmV4cG9ydCB7IENsaWVudCB9O1xuIl19