"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.GridStoreAdapter = void 0;

var _mongodb = require("mongodb");

var _FilesAdapter = require("./FilesAdapter");

var _defaults = _interopRequireDefault(require("../../defaults"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 GridStoreAdapter
 Stores files in Mongo using GridStore
 Requires the database adapter to be based on mongoclient
 (GridStore is deprecated, Please use GridFSBucket instead)

 
 */
// -disable-next
class GridStoreAdapter extends _FilesAdapter.FilesAdapter {
  constructor(mongoDatabaseURI = _defaults.default.DefaultMongoURI, mongoOptions = {}) {
    super();
    this._databaseURI = mongoDatabaseURI;
    const defaultMongoOptions = {
      useNewUrlParser: true,
      useUnifiedTopology: true
    };
    this._mongoOptions = Object.assign(defaultMongoOptions, mongoOptions);
  }

  _connect() {
    if (!this._connectionPromise) {
      this._connectionPromise = _mongodb.MongoClient.connect(this._databaseURI, this._mongoOptions).then(client => {
        this._client = client;
        return client.db(client.s.options.dbName);
      });
    }

    return this._connectionPromise;
  } // For a given config object, filename, and data, store a file
  // Returns a promise


  createFile(filename, data) {
    return this._connect().then(database => {
      const gridStore = new _mongodb.GridStore(database, filename, 'w');
      return gridStore.open();
    }).then(gridStore => {
      return gridStore.write(data);
    }).then(gridStore => {
      return gridStore.close();
    });
  }

  deleteFile(filename) {
    return this._connect().then(database => {
      const gridStore = new _mongodb.GridStore(database, filename, 'r');
      return gridStore.open();
    }).then(gridStore => {
      return gridStore.unlink();
    }).then(gridStore => {
      return gridStore.close();
    });
  }

  getFileData(filename) {
    return this._connect().then(database => {
      return _mongodb.GridStore.exist(database, filename).then(() => {
        const gridStore = new _mongodb.GridStore(database, filename, 'r');
        return gridStore.open();
      });
    }).then(gridStore => {
      return gridStore.read();
    });
  }

  getFileLocation(config, filename) {
    return config.mount + '/files/' + config.applicationId + '/' + encodeURIComponent(filename);
  }

  async handleFileStream(filename, req, res, contentType) {
    const stream = await this._connect().then(database => {
      return _mongodb.GridStore.exist(database, filename).then(() => {
        const gridStore = new _mongodb.GridStore(database, filename, 'r');
        return gridStore.open();
      });
    });
    handleRangeRequest(stream, req, res, contentType);
  }

  handleShutdown() {
    if (!this._client) {
      return Promise.resolve();
    }

    return this._client.close(false);
  }

} // handleRangeRequest is licensed under Creative Commons Attribution 4.0 International License (https://creativecommons.org/licenses/by/4.0/).
// Author: LEROIB at weightingformypizza (https://weightingformypizza.wordpress.com/2015/06/24/stream-html5-media-content-like-video-audio-from-mongodb-using-express-and-gridstore/).


exports.GridStoreAdapter = GridStoreAdapter;

function handleRangeRequest(stream, req, res, contentType) {
  const buffer_size = 1024 * 1024; //1024Kb
  // Range request, partial stream the file

  const parts = req.get('Range').replace(/bytes=/, '').split('-');
  let [start, end] = parts;
  const notEnded = !end && end !== 0;
  const notStarted = !start && start !== 0; // No end provided, we want all bytes

  if (notEnded) {
    end = stream.length - 1;
  } // No start provided, we're reading backwards


  if (notStarted) {
    start = stream.length - end;
    end = start + end - 1;
  } // Data exceeds the buffer_size, cap


  if (end - start >= buffer_size) {
    end = start + buffer_size - 1;
  }

  const contentLength = end - start + 1;
  res.writeHead(206, {
    'Content-Range': 'bytes ' + start + '-' + end + '/' + stream.length,
    'Accept-Ranges': 'bytes',
    'Content-Length': contentLength,
    'Content-Type': contentType
  });
  stream.seek(start, function () {
    // Get gridFile stream
    const gridFileStream = stream.stream(true);
    let bufferAvail = 0;
    let remainingBytesToWrite = contentLength;
    let totalBytesWritten = 0; // Write to response

    gridFileStream.on('data', function (data) {
      bufferAvail += data.length;

      if (bufferAvail > 0) {
        // slice returns the same buffer if overflowing
        // safe to call in any case
        const buffer = data.slice(0, remainingBytesToWrite); // Write the buffer

        res.write(buffer); // Increment total

        totalBytesWritten += buffer.length; // Decrement remaining

        remainingBytesToWrite -= data.length; // Decrement the available buffer

        bufferAvail -= buffer.length;
      } // In case of small slices, all values will be good at that point
      // we've written enough, end...


      if (totalBytesWritten >= contentLength) {
        stream.close();
        res.end();
        this.destroy();
      }
    });
  });
}

var _default = GridStoreAdapter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9GaWxlcy9HcmlkU3RvcmVBZGFwdGVyLmpzIl0sIm5hbWVzIjpbIkdyaWRTdG9yZUFkYXB0ZXIiLCJGaWxlc0FkYXB0ZXIiLCJjb25zdHJ1Y3RvciIsIm1vbmdvRGF0YWJhc2VVUkkiLCJkZWZhdWx0cyIsIkRlZmF1bHRNb25nb1VSSSIsIm1vbmdvT3B0aW9ucyIsIl9kYXRhYmFzZVVSSSIsImRlZmF1bHRNb25nb09wdGlvbnMiLCJ1c2VOZXdVcmxQYXJzZXIiLCJ1c2VVbmlmaWVkVG9wb2xvZ3kiLCJfbW9uZ29PcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiX2Nvbm5lY3QiLCJfY29ubmVjdGlvblByb21pc2UiLCJNb25nb0NsaWVudCIsImNvbm5lY3QiLCJ0aGVuIiwiY2xpZW50IiwiX2NsaWVudCIsImRiIiwicyIsIm9wdGlvbnMiLCJkYk5hbWUiLCJjcmVhdGVGaWxlIiwiZmlsZW5hbWUiLCJkYXRhIiwiZGF0YWJhc2UiLCJncmlkU3RvcmUiLCJHcmlkU3RvcmUiLCJvcGVuIiwid3JpdGUiLCJjbG9zZSIsImRlbGV0ZUZpbGUiLCJ1bmxpbmsiLCJnZXRGaWxlRGF0YSIsImV4aXN0IiwicmVhZCIsImdldEZpbGVMb2NhdGlvbiIsImNvbmZpZyIsIm1vdW50IiwiYXBwbGljYXRpb25JZCIsImVuY29kZVVSSUNvbXBvbmVudCIsImhhbmRsZUZpbGVTdHJlYW0iLCJyZXEiLCJyZXMiLCJjb250ZW50VHlwZSIsInN0cmVhbSIsImhhbmRsZVJhbmdlUmVxdWVzdCIsImhhbmRsZVNodXRkb3duIiwiUHJvbWlzZSIsInJlc29sdmUiLCJidWZmZXJfc2l6ZSIsInBhcnRzIiwiZ2V0IiwicmVwbGFjZSIsInNwbGl0Iiwic3RhcnQiLCJlbmQiLCJub3RFbmRlZCIsIm5vdFN0YXJ0ZWQiLCJsZW5ndGgiLCJjb250ZW50TGVuZ3RoIiwid3JpdGVIZWFkIiwic2VlayIsImdyaWRGaWxlU3RyZWFtIiwiYnVmZmVyQXZhaWwiLCJyZW1haW5pbmdCeXRlc1RvV3JpdGUiLCJ0b3RhbEJ5dGVzV3JpdHRlbiIsIm9uIiwiYnVmZmVyIiwic2xpY2UiLCJkZXN0cm95Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBVUE7O0FBQ0E7O0FBQ0E7Ozs7QUFaQTs7Ozs7Ozs7QUFTQTtBQUtPLE1BQU1BLGdCQUFOLFNBQStCQywwQkFBL0IsQ0FBNEM7QUFLakRDLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQWdCLEdBQUdDLGtCQUFTQyxlQUE3QixFQUE4Q0MsWUFBWSxHQUFHLEVBQTdELEVBQWlFO0FBQzFFO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQkosZ0JBQXBCO0FBRUEsVUFBTUssbUJBQW1CLEdBQUc7QUFDMUJDLE1BQUFBLGVBQWUsRUFBRSxJQURTO0FBRTFCQyxNQUFBQSxrQkFBa0IsRUFBRTtBQUZNLEtBQTVCO0FBSUEsU0FBS0MsYUFBTCxHQUFxQkMsTUFBTSxDQUFDQyxNQUFQLENBQWNMLG1CQUFkLEVBQW1DRixZQUFuQyxDQUFyQjtBQUNEOztBQUVEUSxFQUFBQSxRQUFRLEdBQUc7QUFDVCxRQUFJLENBQUMsS0FBS0Msa0JBQVYsRUFBOEI7QUFDNUIsV0FBS0Esa0JBQUwsR0FBMEJDLHFCQUFZQyxPQUFaLENBQ3hCLEtBQUtWLFlBRG1CLEVBRXhCLEtBQUtJLGFBRm1CLEVBR3hCTyxJQUh3QixDQUduQkMsTUFBTSxJQUFJO0FBQ2YsYUFBS0MsT0FBTCxHQUFlRCxNQUFmO0FBQ0EsZUFBT0EsTUFBTSxDQUFDRSxFQUFQLENBQVVGLE1BQU0sQ0FBQ0csQ0FBUCxDQUFTQyxPQUFULENBQWlCQyxNQUEzQixDQUFQO0FBQ0QsT0FOeUIsQ0FBMUI7QUFPRDs7QUFDRCxXQUFPLEtBQUtULGtCQUFaO0FBQ0QsR0EzQmdELENBNkJqRDtBQUNBOzs7QUFDQVUsRUFBQUEsVUFBVSxDQUFDQyxRQUFELEVBQW1CQyxJQUFuQixFQUF5QjtBQUNqQyxXQUFPLEtBQUtiLFFBQUwsR0FDSkksSUFESSxDQUNDVSxRQUFRLElBQUk7QUFDaEIsWUFBTUMsU0FBUyxHQUFHLElB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IFN0b3JlcyBmaWxlcyBpbiBNb25nbyB1c2luZyBHcmlkU3RvcmVcbiBSZXF1aXJlcyB0aGUgZGF0YWJhc2UgYWRhcHRlciB0byBiZSBiYXNlZCBvbiBtb25nb2NsaWVudFxuIChHcmlkU3RvcmUgaXMgZGVwcmVjYXRlZCwgUGxlYXNlIHVzZSBHcmlkRlNCdWNrZXQgaW5zdGVhZClcblxuIEBmbG93IHdlYWtcbiAqL1xuXG4vLyBAZmxvdy1kaXNhYmxlLW5leHRcbmltcG9ydCB7IE1vbmdvQ2xpZW50LCBHcmlkU3RvcmUsIERiIH0gZnJvbSAnbW9uZ29kYic7XG5pbXBvcnQgeyBGaWxlc0FkYXB0ZXIgfSBmcm9tICcuL0ZpbGVzQWRhcHRlcic7XG5pbXBvcnQgZGVmYXVsdHMgZnJvbSAnLi4vLi4vZGVmYXVsdHMnO1xuXG5leHBvcnQgY2xhc3MgR3JpZFN0b3JlQWRhcHRlciBleHRlbmRzIEZpbGVzQWRhcHRlciB7XG4gIF9kYXRhYmFzZVVSSTogc3RyaW5nO1xuICBfY29ubmVjdGlvblByb21pc2U6IFByb21pc2U8RGI+O1xuICBfbW9uZ29PcHRpb25zOiBPYmplY3Q7XG5cbiAgY29uc3RydWN0b3IobW9uZ29EYXRhYmFzZVVSSSA9IGRlZmF1bHRzLkRlZmF1bHRNb25nb1VSSSwgbW9uZ29PcHRpb25zID0ge30pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2RhdGFiYXNlVVJJID0gbW9uZ29EYXRhYmFzZVVSSTtcblxuICAgIGNvbnN0IGRlZmF1bHRNb25nb09wdGlvbnMgPSB7XG4gICAgICB1c2VOZXdVcmxQYXJzZXI6IHRydWUsXG4gICAgICB1c2VVbmlmaWVkVG9wb2xvZ3k6IHRydWUsXG4gICAgfTtcbiAgICB0aGlzLl9tb25nb09wdGlvbnMgPSBPYmplY3QuYXNzaWduKGRlZmF1bHRNb25nb09wdGlvbnMsIG1vbmdvT3B0aW9ucyk7XG4gIH1cblxuICBfY29ubmVjdCgpIHtcbiAgICBpZiAoIXRoaXMuX2Nvbm5lY3Rpb25Qcm9taXNlKSB7XG4gICAgICB0aGlzLl9jb25uZWN0aW9uUHJvbWlzZSA9IE1vbmdvQ2xpZW50LmNvbm5lY3QoXG4gICAgICAgIHRoaXMuX2RhdGFiYXNlVVJJLFxuICAgICAgICB0aGlzLl9tb25nb09wdGlvbnNcbiAgICAgICkudGhlbihjbGllbnQgPT4ge1xuICAgICAgICB0aGlzLl9jbGllbnQgPSBjbGllbnQ7XG4gICAgICAgIHJldHVybiBjbGllbnQuZGIoY2xpZW50LnMub3B0aW9ucy5kYk5hbWUpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uUHJvbWlzZTtcbiAgfVxuXG4gIC8vIEZvciBhIGdpdmVuIGNvbmZpZyBvYmplY3QsIGZpbGVuYW1lLCBhbmQgZGF0YSwgc3RvcmUgYSBmaWxlXG4gIC8vIFJldHVybnMgYSBwcm9taXNlXG4gIGNyZWF0ZUZpbGUoZmlsZW5hbWU6IHN0cmluZywgZGF0YSkge1xuICAgIHJldHVybiB0aGlzLl9jb25uZWN0KClcbiAgICAgIC50aGVuKGRhdGFiYXNlID0+IHtcbiAgICAgICAgY29uc3QgZ3JpZFN0b3JlID0gbmV3IEdyaWRTdG9yZShkYXRhYmFzZSwgZmlsZW5hbWUsICd3Jyk7XG4gICAgICAgIHJldHVybiBncmlkU3RvcmUub3BlbigpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGdyaWRTdG9yZSA9PiB7XG4gICAgICAgIHJldHVybiBncmlkU3RvcmUud3JpdGUoZGF0YSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oZ3JpZFN0b3JlID0+IHtcbiAgICAgICAgcmV0dXJuIGdyaWRTdG9yZS5jbG9zZSgpO1xuICAgICAgfSk7XG4gIH1cblxuICBkZWxldGVGaWxlKGZpbGVuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdCgpXG4gICAgICAudGhlbihkYXRhYmFzZSA9PiB7XG4gICAgICAgIGNvbnN0IGdyaWRTdG9yZSA9IG5ldyBHcmlkU3RvcmUoZGF0YWJhc2UsIGZpbGVuYW1lLCAncicpO1xuICAgICAgICByZXR1cm4gZ3JpZFN0b3JlLm9wZW4oKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihncmlkU3RvcmUgPT4ge1xuICAgICAgICByZXR1cm4gZ3JpZFN0b3JlLnVubGluaygpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGdyaWRTdG9yZSA9PiB7XG4gICAgICAgIHJldHVybiBncmlkU3RvcmUuY2xvc2UoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZ2V0RmlsZURhdGEoZmlsZW5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl9jb25uZWN0KClcbiAgICAgIC50aGVuKGRhdGFiYXNlID0+IHtcbiAgICAgICAgcmV0dXJuIEdyaWRTdG9yZS5leGlzdChkYXRhYmFzZSwgZmlsZW5hbWUpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGdyaWRTdG9yZSA9IG5ldyBHcmlkU3RvcmUoZGF0YWJhc2UsIGZpbGVuYW1lLCAncicpO1xuICAgICAgICAgIHJldHVybiBncmlkU3RvcmUub3BlbigpO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAudGhlbihncmlkU3RvcmUgPT4ge1xuICAgICAgICByZXR1cm4gZ3JpZFN0b3JlLnJlYWQoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZ2V0RmlsZUxvY2F0aW9uKGNvbmZpZywgZmlsZW5hbWUpIHtcbiAgICByZXR1cm4gKFxuICAgICAgY29uZmlnLm1vdW50ICtcbiAgICAgICcvZmlsZXMvJyArXG4gICAgICBjb25maWcuYXBwbGljYXRpb25JZCArXG4gICAgICAnLycgK1xuICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KGZpbGVuYW1lKVxuICAgICk7XG4gIH1cblxuICBhc3luYyBoYW5kbGVGaWxlU3RyZWFtKGZpbGVuYW1lOiBzdHJpbmcsIHJlcSwgcmVzLCBjb250ZW50VHlwZSkge1xuICAgIGNvbnN0IHN0cmVhbSA9IGF3YWl0IHRoaXMuX2Nvbm5lY3QoKS50aGVuKGRhdGFiYXNlID0+IHtcbiAgICAgIHJldHVybiBHcmlkU3RvcmUuZXhpc3QoZGF0YWJhc2UsIGZpbGVuYW1lKS50aGVuKCgpID0+IHtcbiAgICAgICAgY29uc3QgZ3JpZFN0b3JlID0gbmV3IEdyaWRTdG9yZShkYXRhYmFzZSwgZmlsZW5hbWUsICdyJyk7XG4gICAgICAgIHJldHVybiBncmlkU3RvcmUub3BlbigpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgaGFuZGxlUmFuZ2VSZXF1ZXN0KHN0cmVhbSwgcmVxLCByZXMsIGNvbnRlbnRUeXBlKTtcbiAgfVxuXG4gIGhhbmRsZVNodXRkb3duKCkge1xuICAgIGlmICghdGhpcy5fY2xpZW50KSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jbGllbnQuY2xvc2UoZmFsc2UpO1xuICB9XG59XG5cbi8vIGhhbmRsZVJhbmdlUmVxdWVzdCBpcyBsaWNlbnNlZCB1bmRlciBDcmVhdGl2ZSBDb21tb25zIEF0dHJpYnV0aW9uIDQuMCBJbnRlcm5hdGlvbmFsIExpY2Vuc2UgKGh0dHBzOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS80LjAvKS5cbi8vIEF1dGhvcjogTEVST0lCIGF0IHdlaWdodGluZ2Zvcm15cGl6emEgKGh0dHBzOi8vd2VpZ2h0aW5nZm9ybXlwaXp6YS53b3JkcHJlc3MuY29tLzIwMTUvMDYvMjQvc3RyZWFtLWh0bWw1LW1lZGlhLWNvbnRlbnQtbGlrZS12aWRlby1hdWRpby1mcm9tLW1vbmdvZGItdXNpbmctZXhwcmVzcy1hbmQtZ3JpZHN0b3JlLykuXG5mdW5jdGlvbiBoYW5kbGVSYW5nZVJlcXVlc3Qoc3RyZWFtLCByZXEsIHJlcywgY29udGVudFR5cGUpIHtcbiAgY29uc3QgYnVmZmVyX3NpemUgPSAxMDI0ICogMTAyNDsgLy8xMDI0S2JcbiAgLy8gUmFuZ2UgcmVxdWVzdCwgcGFydGlhbCBzdHJlYW0gdGhlIGZpbGVcbiAgY29uc3QgcGFydHMgPSByZXFcbiAgICAuZ2V0KCdSYW5nZScpXG4gICAgLnJlcGxhY2UoL2J5dGVzPS8sICcnKVxuICAgIC5zcGxpdCgnLScpO1xuICBsZXQgW3N0YXJ0LCBlbmRdID0gcGFydHM7XG4gIGNvbnN0IG5vdEVuZGVkID0gIWVuZCAmJiBlbmQgIT09IDA7XG4gIGNvbnN0IG5vdFN0YXJ0ZWQgPSAhc3RhcnQgJiYgc3RhcnQgIT09IDA7XG4gIC8vIE5vIGVuZCBwcm92aWRlZCwgd2Ugd2FudCBhbGwgYnl0ZXNcbiAgaWYgKG5vdEVuZGVkKSB7XG4gICAgZW5kID0gc3RyZWFtLmxlbmd0aCAtIDE7XG4gIH1cbiAgLy8gTm8gc3RhcnQgcHJvdmlkZWQsIHdlJ3JlIHJlYWRpbmcgYmFja3dhcmRzXG4gIGlmIChub3RTdGFydGVkKSB7XG4gICAgc3RhcnQgPSBzdHJlYW0ubGVuZ3RoIC0gZW5kO1xuICAgIGVuZCA9IHN0YXJ0ICsgZW5kIC0gMTtcbiAgfVxuXG4gIC8vIERhdGEgZXhjZWVkcyB0aGUgYnVmZmVyX3NpemUsIGNhcFxuICBpZiAoZW5kIC0gc3RhcnQgPj0gYnVmZmVyX3NpemUpIHtcbiAgICBlbmQgPSBzdGFydCArIGJ1ZmZlcl9zaXplIC0gMTtcbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnRMZW5ndGggPSBlbmQgLSBzdGFydCArIDE7XG5cbiAgcmVzLndyaXRlSGVhZCgyMDYsIHtcbiAgICAnQ29udGVudC1SYW5nZSc6ICdieXRlcyAnICsgc3RhcnQgKyAnLScgKyBlbmQgKyAnLycgKyBzdHJlYW0ubGVuZ3RoLFxuICAgICdBY2NlcHQtUmFuZ2VzJzogJ2J5dGVzJyxcbiAgICAnQ29udGVudC1MZW5ndGgnOiBjb250ZW50TGVuZ3RoLFxuICAgICdDb250ZW50LVR5cGUnOiBjb250ZW50VHlwZSxcbiAgfSk7XG5cbiAgc3RyZWFtLnNlZWsoc3RhcnQsIGZ1bmN0aW9uKCkge1xuICAgIC8vIEdldCBncmlkRmlsZSBzdHJlYW1cbiAgICBjb25zdCBncmlkRmlsZVN0cmVhbSA9IHN0cmVhbS5zdHJlYW0odHJ1ZSk7XG4gICAgbGV0IGJ1ZmZlckF2YWlsID0gMDtcbiAgICBsZXQgcmVtYWluaW5nQnl0ZXNUb1dyaXRlID0gY29udGVudExlbmd0aDtcbiAgICBsZXQgdG90YWxCeXRlc1dyaXR0ZW4gPSAwO1xuICAgIC8vIFdyaXRlIHRvIHJlc3BvbnNlXG4gICAgZ3JpZEZpbGVTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICBidWZmZXJBdmFpbCArPSBkYXRhLmxlbmd0aDtcbiAgICAgIGlmIChidWZmZXJBdmFpbCA+IDApIHtcbiAgICAgICAgLy8gc2xpY2UgcmV0dXJucyB0aGUgc2FtZSBidWZmZXIgaWYgb3ZlcmZsb3dpbmdcbiAgICAgICAgLy8gc2FmZSB0byBjYWxsIGluIGFueSBjYXNlXG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IGRhdGEuc2xpY2UoMCwgcmVtYWluaW5nQnl0ZXNUb1dyaXRlKTtcbiAgICAgICAgLy8gV3JpdGUgdGhlIGJ1ZmZlclxuICAgICAgICByZXMud3JpdGUoYnVmZmVyKTtcbiAgICAgICAgLy8gSW5jcmVtZW50IHRvdGFsXG4gICAgICAgIHRvdGFsQnl0ZXNXcml0dGVuICs9IGJ1ZmZlci5sZW5ndGg7XG4gICAgICAgIC8vIERlY3JlbWVudCByZW1haW5pbmdcbiAgICAgICAgcmVtYWluaW5nQnl0ZXNUb1dyaXRlIC09IGRhdGEubGVuZ3RoO1xuICAgICAgICAvLyBEZWNyZW1lbnQgdGhlIGF2YWlsYWJsZSBidWZmZXJcbiAgICAgICAgYnVmZmVyQXZhaWwgLT0gYnVmZmVyLmxlbmd0aDtcbiAgICAgIH1cbiAgICAgIC8vIEluIGNhc2Ugb2Ygc21hbGwgc2xpY2VzLCBhbGwgdmFsdWVzIHdpbGwgYmUgZ29vZCBhdCB0aGF0IHBvaW50XG4gICAgICAvLyB3ZSd2ZSB3cml0dGVuIGVub3VnaCwgZW5kLi4uXG4gICAgICBpZiAodG90YWxCeXRlc1dyaXR0ZW4gPj0gY29udGVudExlbmd0aCkge1xuICAgICAgICBzdHJlYW0uY2xvc2UoKTtcbiAgICAgICAgcmVzLmVuZCgpO1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IEdyaWRTdG9yZUFkYXB0ZXI7XG4iXX0=