"use strict";

const url = require('url');

const fs = require('fs');

function getDatabaseOptionsFromURI(uri) {
  const databaseOptions = {};
  const parsedURI = url.parse(uri);
  const queryParams = parseQueryParams(parsedURI.query);
  const authParts = parsedURI.auth ? parsedURI.auth.split(':') : [];
  databaseOptions.host = parsedURI.hostname || 'localhost';
  databaseOptions.port = parsedURI.port ? parseInt(parsedURI.port) : 5432;
  databaseOptions.database = parsedURI.pathname ? parsedURI.pathname.substr(1) : undefined;
  databaseOptions.user = authParts.length > 0 ? authParts[0] : '';
  databaseOptions.password = authParts.length > 1 ? authParts[1] : '';

  if (queryParams.ssl && queryParams.ssl.toLowerCase() === 'true') {
    databaseOptions.ssl = true;
  }

  if (queryParams.ca || queryParams.pfx || queryParams.cert || queryParams.key || queryParams.passphrase || queryParams.rejectUnauthorized || queryParams.secureOptions) {
    databaseOptions.ssl = {};

    if (queryParams.ca) {
      databaseOptions.ssl.ca = fs.readFileSync(queryParams.ca).toString();
    }

    if (queryParams.pfx) {
      databaseOptions.ssl.pfx = fs.readFileSync(queryParams.pfx).toString();
    }

    if (queryParams.cert) {
      databaseOptions.ssl.cert = fs.readFileSync(queryParams.cert).toString();
    }

    if (queryParams.key) {
      databaseOptions.ssl.key = fs.readFileSync(queryParams.key).toString();
    }

    if (queryParams.passphrase) {
      databaseOptions.ssl.passphrase = queryParams.passphrase;
    }

    if (queryParams.rejectUnauthorized) {
      databaseOptions.ssl.rejectUnauthorized = queryParams.rejectUnauthorized.toLowerCase() === 'true' ? true : false;
    }

    if (queryParams.secureOptions) {
      databaseOptions.ssl.secureOptions = parseInt(queryParams.secureOptions);
    }
  }

  databaseOptions.binary = queryParams.binary && queryParams.binary.toLowerCase() === 'true' ? true : false;
  databaseOptions.client_encoding = queryParams.client_encoding;
  databaseOptions.application_name = queryParams.application_name;
  databaseOptions.fallback_application_name = queryParams.fallback_application_name;

  if (queryParams.poolSize) {
    databaseOptions.poolSize = parseInt(queryParams.poolSize) || 10;
  }

  if (queryParams.max) {
    databaseOptions.max = parseInt(queryParams.max) || 10;
  }

  if (queryParams.query_timeout) {
    databaseOptions.query_timeout = parseInt(queryParams.query_timeout);
  }

  if (queryParams.idleTimeoutMillis) {
    databaseOptions.idleTimeoutMillis = parseInt(queryParams.idleTimeoutMillis);
  }

  if (queryParams.keepAlive) {
    databaseOptions.keepAlive = queryParams.keepAlive.toLowerCase() === 'true' ? true : false;
  }

  return databaseOptions;
}

function parseQueryParams(queryString) {
  queryString = queryString || '';
  return queryString.split('&').reduce((p, c) => {
    const parts = c.split('=');
    p[decodeURIComponent(parts[0])] = parts.length > 1 ? decodeURIComponent(parts.slice(1).join('=')) : '';
    return p;
  }, {});
}

module.exports = {
  parseQueryParams: parseQueryParams,
  getDatabaseOptionsFromURI: getDatabaseOptionsFromURI
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL1Bvc3RncmVzL1Bvc3RncmVzQ29uZmlnUGFyc2VyLmpzIl0sIm5hbWVzIjpbInVybCIsInJlcXVpcmUiLCJmcyIsImdldERhdGFiYXNlT3B0aW9uc0Zyb21VUkkiLCJ1cmkiLCJkYXRhYmFzZU9wdGlvbnMiLCJwYXJzZWRVUkkiLCJwYXJzZSIsInF1ZXJ5UGFyYW1zIiwicGFyc2VRdWVyeVBhcmFtcyIsInF1ZXJ5IiwiYXV0aFBhcnRzIiwiYXV0aCIsInNwbGl0IiwiaG9zdCIsImhvc3RuYW1lIiwicG9ydCIsInBhcnNlSW50IiwiZGF0YWJhc2UiLCJwYXRobmFtZSIsInN1YnN0ciIsInVuZGVmaW5lZCIsInVzZXIiLCJsZW5ndGgiLCJwYXNzd29yZCIsInNzbCIsInRvTG93ZXJDYXNlIiwiY2EiLCJwZngiLCJjZXJ0Iiwia2V5IiwicGFzc3BocmFzZSIsInJlamVjdFVuYXV0aG9yaXplZCIsInNlY3VyZU9wdGlvbnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsImJpbmFyeSIsImNsaWVudF9lbmNvZGluZyIsImFwcGxpY2F0aW9uX25hbWUiLCJmYWxsYmFja19hcHBsaWNhdGlvbl9uYW1lIiwicG9vbFNpemUiLCJtYXgiLCJxdWVyeV90aW1lb3V0IiwiaWRsZVRpbWVvdXRNaWxsaXMiLCJrZWVwQWxpdmUiLCJxdWVyeVN0cmluZyIsInJlZHVjZSIsInAiLCJjIiwicGFydHMiLCJkZWNvZGVVUklDb21wb25lbnQiLCJzbGljZSIsImpvaW4iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEdBQUcsR0FBR0MsT0FBTyxDQUFDLEtBQUQsQ0FBbkI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxTQUFTRSx5QkFBVCxDQUFtQ0MsR0FBbkMsRUFBd0M7QUFDdEMsUUFBTUMsZUFBZSxHQUFHLEVBQXhCO0FBRUEsUUFBTUMs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QUFGWixDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHVybCA9IHJlcXVpcmUoJ3VybCcpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuZnVuY3Rpb24gZ2V0RGF0YWJhc2VPcHRpb25zRnJvbVVSSSh1cmkpIHtcbiAgY29uc3QgZGF0YWJhc2VPcHRpb25zID0ge307XG5cbiAgY29uc3QgcGFyc2VkVVJJID0gdXJsLnBhcnNlKHVyaSk7XG4gIGNvbnN0IHF1ZXJ5UGFyYW1zID0gcGFyc2VRdWVyeVBhcmFtcyhwYXJzZWRVUkkucXVlcnkpO1xuICBjb25zdCBhdXRoUGFydHMgPSBwYXJzZWRVUkkuYXV0aCA/IHBhcnNlZFVSSS5hdXRoLnNwbGl0KCc6JykgOiBbXTtcblxuICBkYXRhYmFzZU9wdGlvbnMuaG9zdCA9IHBhcnNlZFVSSS5ob3N0bmFtZSB8fCAnbG9jYWxob3N0JztcbiAgZGF0YWJhc2VPcHRpb25zLnBvcnQgPSBwYXJzZWRVUkkucG9ydCA/IHBhcnNlSW50KHBhcnNlZFVSSS5wb3J0KSA6IDU0MzI7XG4gIGRhdGFiYXNlT3B0aW9ucy5kYXRhYmFzZSA9IHBhcnNlZFVSSS5wYXRobmFtZVxuICAgID8gcGFyc2VkVVJJLnBhdGhuYW1lLnN1YnN0cigxKVxuICAgIDogdW5kZWZpbmVkO1xuXG4gIGRhdGFiYXNlT3B0aW9ucy51c2VyID0gYXV0aFBhcnRzLmxlbmd0aCA+IDAgPyBhdXRoUGFydHNbMF0gOiAnJztcbiAgZGF0YWJhc2VPcHRpb25zLnBhc3N3b3JkID0gYXV0aFBhcnRzLmxlbmd0aCA+IDEgPyBhdXRoUGFydHNbMV0gOiAnJztcblxuICBpZiAocXVlcnlQYXJhbXMuc3NsICYmIHF1ZXJ5UGFyYW1zLnNzbC50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZScpIHtcbiAgICBkYXRhYmFzZU9wdGlvbnMuc3NsID0gdHJ1ZTtcbiAgfVxuXG4gIGlmIChcbiAgICBxdWVyeVBhcmFtcy5jYSB8fFxuICAgIHF1ZXJ5UGFyYW1zLnBmeCB8fFxuICAgIHF1ZXJ5UGFyYW1zLmNlcnQgfHxcbiAgICBxdWVyeVBhcmFtcy5rZXkgfHxcbiAgICBxdWVyeVBhcmFtcy5wYXNzcGhyYXNlIHx8XG4gICAgcXVlcnlQYXJhbXMucmVqZWN0VW5hdXRob3JpemVkIHx8XG4gICAgcXVlcnlQYXJhbXMuc2VjdXJlT3B0aW9uc1xuICApIHtcbiAgICBkYXRhYmFzZU9wdGlvbnMuc3NsID0ge307XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLmNhKSB7XG4gICAgICBkYXRhYmFzZU9wdGlvbnMuc3NsLmNhID0gZnMucmVhZEZpbGVTeW5jKHF1ZXJ5UGFyYW1zLmNhKS50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAocXVlcnlQYXJhbXMucGZ4KSB7XG4gICAgICBkYXRhYmFzZU9wdGlvbnMuc3NsLnBmeCA9IGZzLnJlYWRGaWxlU3luYyhxdWVyeVBhcmFtcy5wZngpLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmIChxdWVyeVBhcmFtcy5jZXJ0KSB7XG4gICAgICBkYXRhYmFzZU9wdGlvbnMuc3NsLmNlcnQgPSBmcy5yZWFkRmlsZVN5bmMocXVlcnlQYXJhbXMuY2VydCkudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLmtleSkge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5rZXkgPSBmcy5yZWFkRmlsZVN5bmMocXVlcnlQYXJhbXMua2V5KS50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAocXVlcnlQYXJhbXMucGFzc3BocmFzZSkge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5wYXNzcGhyYXNlID0gcXVlcnlQYXJhbXMucGFzc3BocmFzZTtcbiAgICB9XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLnJlamVjdFVuYXV0aG9yaXplZCkge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5yZWplY3RVbmF1dGhvcml6ZWQgPVxuICAgICAgICBxdWVyeVBhcmFtcy5yZWplY3RVbmF1dGhvcml6ZWQudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnID8gdHJ1ZSA6IGZhbHNlO1xuICAgIH1cbiAgICBpZiAocXVlcnlQYXJhbXMuc2VjdXJlT3B0aW9ucykge1xuICAgICAgZGF0YWJhc2VPcHRpb25zLnNzbC5zZWN1cmVPcHRpb25zID0gcGFyc2VJbnQocXVlcnlQYXJhbXMuc2VjdXJlT3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgZGF0YWJhc2VPcHRpb25zLmJpbmFyeSA9XG4gICAgcXVlcnlQYXJhbXMuYmluYXJ5ICYmIHF1ZXJ5UGFyYW1zLmJpbmFyeS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSdcbiAgICAgID8gdHJ1ZVxuICAgICAgOiBmYWxzZTtcblxuICBkYXRhYmFzZU9wdGlvbnMuY2xpZW50X2VuY29kaW5nID0gcXVlcnlQYXJhbXMuY2xpZW50X2VuY29kaW5nO1xuICBkYXRhYmFzZU9wdGlvbnMuYXBwbGljYXRpb25fbmFtZSA9IHF1ZXJ5UGFyYW1zLmFwcGxpY2F0aW9uX25hbWU7XG4gIGRhdGFiYXNlT3B0aW9ucy5mYWxsYmFja19hcHBsaWNhdGlvbl9uYW1lID1cbiAgICBxdWVyeVBhcmFtcy5mYWxsYmFja19hcHBsaWNhdGlvbl9uYW1lO1xuXG4gIGlmIChxdWVyeVBhcmFtcy5wb29sU2l6ZSkge1xuICAgIGRhdGFiYXNlT3B0aW9ucy5wb29sU2l6ZSA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnBvb2xTaXplKSB8fCAxMDtcbiAgfVxuICBpZiAocXVlcnlQYXJhbXMubWF4KSB7XG4gICAgZGF0YWJhc2VPcHRpb25zLm1heCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLm1heCkgfHwgMTA7XG4gIH1cbiAgaWYgKHF1ZXJ5UGFyYW1zLnF1ZXJ5X3RpbWVvdXQpIHtcbiAgICBkYXRhYmFzZU9wdGlvbnMucXVlcnlfdGltZW91dCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnF1ZXJ5X3RpbWVvdXQpO1xuICB9XG4gIGlmIChxdWVyeVBhcmFtcy5pZGxlVGltZW91dE1pbGxpcykge1xuICAgIGRhdGFiYXNlT3B0aW9ucy5pZGxlVGltZW91dE1pbGxpcyA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmlkbGVUaW1lb3V0TWlsbGlzKTtcbiAgfVxuICBpZiAocXVlcnlQYXJhbXMua2VlcEFsaXZlKSB7XG4gICAgZGF0YWJhc2VPcHRpb25zLmtlZXBBbGl2ZSA9XG4gICAgICBxdWVyeVBhcmFtcy5rZWVwQWxpdmUudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIGRhdGFiYXNlT3B0aW9ucztcbn1cblxuZnVuY3Rpb24gcGFyc2VRdWVyeVBhcmFtcyhxdWVyeVN0cmluZykge1xuICBxdWVyeVN0cmluZyA9IHF1ZXJ5U3RyaW5nIHx8ICcnO1xuXG4gIHJldHVybiBxdWVyeVN0cmluZy5zcGxpdCgnJicpLnJlZHVjZSgocCwgYykgPT4ge1xuICAgIGNvbnN0IHBhcnRzID0gYy5zcGxpdCgnPScpO1xuICAgIHBbZGVjb2RlVVJJQ29tcG9uZW50KHBhcnRzWzBdKV0gPVxuICAgICAgcGFydHMubGVuZ3RoID4gMSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJ0cy5zbGljZSgxKS5qb2luKCc9JykpIDogJyc7XG4gICAgcmV0dXJuIHA7XG4gIH0sIHt9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHBhcnNlUXVlcnlQYXJhbXM6IHBhcnNlUXVlcnlQYXJhbXMsXG4gIGdldERhdGFiYXNlT3B0aW9uc0Zyb21VUkk6IGdldERhdGFiYXNlT3B0aW9uc0Zyb21VUkksXG59O1xuIl19